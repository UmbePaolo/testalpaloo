function SetToken(){SendAjaxRequest("api/auth/login",null,setHeaderForLogin,"GetMessageLogin")}function SendAjaxRequest(n,t,i,r){$.ajax({url:domain+n,type:"POST",dataType:"json",data:t,processData:!1,success:function(n){var t=new ControllerRequest;t[r](n)},error:function(){},beforeSend:i})}function SetData(){var n=qs.date.split("/"),t=n[2]+"-"+n[1]+"-"+n[0],i={UserId:qs.uid,userRequestId:qs.uid,Date:t},r=JSON.stringify(i);SendAjaxRequest("api/skiday",r,setCustomHeaderToken,"GetMessage")}function setData(n){if(n&&(data=n,!(data.liftsTaken.length<1))){data.liftsTaken.sort(function(n,t){return n.liftTime<t.liftTime?-1:n.liftTime>t.liftTime?1:0});$("meta[property=og\\:title]").attr("content","La mia giornata sci a "+data.resortName);var t="Metri risaliti: "+data.mtTotRisaliti+" – Ore di attività: "+data.hTotAttivita+" – Impianti presi: "+data.liftsTaken.length;$("meta[property=og\\:description]").attr("content",t);loadImage()}}function LiftsTakenEquals(n,t){return!n||!t?!1:n.liftName===t.liftName}function loadImage(){if(imgResort=document.createElement("img"),imgResort)switch(data.resortName){case"Courmayeur":imgResort.src="img/Courmayeur.png";break;case"Monterosa":imgResort.src="img/Monterosa.png";case"La Thuile":imgResort.src="img/LaThuile.png";break;default:imgResort.src="img/Courmayeur.png"}imgResort.onload=function(){canvas=document.getElementById("imgCanvas");var t=canvas.getContext("2d"),n=$(window).innerWidth()/imgResort.width;canvas.height=imgResort.height*n;canvas.width=$(window).innerWidth();imgSize=calculateAspectRatioFit(imgResort.width,imgResort.height,canvas.width,canvas.height);drawImage();prepareAvatar();loadGraph()}}function drawImage(){var n=canvas.getContext("2d");n.drawImage(imgResort,0,0,imgSize.width,imgSize.height)}function getPoint(n,t){return Math.floor(n/100*t)}function calculateAspectRatioFit(n,t,i,r){var u=Math.min(i/n,r/t),f=n*u,e=t*u;return{width:f,height:e}}function dataURItoBlob(n){for(var i=atob(n.split(",")[1]),r=new ArrayBuffer(i.length),u=new Uint8Array(r),t=0;t<i.length;t++)u[t]=i.charCodeAt(t);return new Blob([r],{type:"image/png"})}function ShareFB2(){var t=new GIFEncoder,n,u,i,r,f;t.setRepeat(0);t.setDelay(1e3);t.start();n=canvas.getContext("2d");indiceWayPoint.Index=0;updateAvatar();n.beginPath();n.arc(arrayDistanzaX[indiceWayPoint.Index]+20,arrayDistanzaY[indiceWayPoint.Index],20,0,2*Math.PI,!1);n.fillStyle="green";n.fill();n.lineWidth=5;n.strokeStyle="#003300";n.stroke();t.addFrame(n);indiceWayPoint.Index=1;updateAvatar();n.beginPath();n.arc(arrayDistanzaX[indiceWayPoint.Index]+20,arrayDistanzaY[indiceWayPoint.Index],20,0,2*Math.PI,!1);n.fillStyle="green";n.fill();n.lineWidth=5;n.strokeStyle="#003300";n.stroke();t.addFrame(n);indiceWayPoint.Index=2;updateAvatar();n.beginPath();n.arc(arrayDistanzaX[indiceWayPoint.Index]+20,arrayDistanzaY[indiceWayPoint.Index],20,0,2*Math.PI,!1);n.fillStyle="green";n.fill();n.lineWidth=5;n.strokeStyle="#003300";n.stroke();t.addFrame(n);indiceWayPoint.Index=3;updateAvatar();n.beginPath();n.arc(arrayDistanzaX[indiceWayPoint.Index]+20,arrayDistanzaY[indiceWayPoint.Index],20,0,2*Math.PI,!1);n.fillStyle="green";n.fill();n.lineWidth=5;n.strokeStyle="#003300";n.stroke();t.addFrame(n);t.finish();u=t.stream().getData();i=encode64(u);console.log(i);r=location.origin+"/";f=data.userName+data.userSurname;$.ajax({type:"POST",url:"UploadImageService.asmx/UploadImage",data:JSON.stringify({imageData:i,name:f}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(n){$("body").append('<meta property="og:image" content="'+r+n.d+'" />');FB.ui({method:"share",href:window.location.href,picture:r+n.d},function(){})})}function encode64(n){for(var e="",t=0,l=n.length,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o,r,u,h,c,s,f;t<l;)o=n.charCodeAt(t++),r=n.charCodeAt(t++),u=n.charCodeAt(t++),h=o>>2,c=(o&3)<<4|r>>4,s=(r&15)<<2|u>>6,f=u&63,isNaN(r)?s=f=64:isNaN(u)&&(f=64),e=e+i.charAt(h)+i.charAt(c)+i.charAt(s)+i.charAt(f);return e}function ShareFB(){var r=canvas.toDataURL("image/png"),u,n,i,t;try{u=dataURItoBlob(r)}catch(f){console.log(f)}$("#divFB").data("href",window.location.href);n=canvas.toDataURL("image/png");n=n.replace("data:image/png;base64,","");i=data.userName+data.userSurname;t=location.origin+"/";$.ajax({type:"POST",url:"UploadImageService.asmx/UploadImage",data:JSON.stringify({imageData:n,name:i}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(n){$("body").append('<meta property="og:image" content="'+t+n.d+'" />');FB.ui({method:"share",href:window.location.href,picture:t+n.d},function(){})})}function postImageToFacebook(n,t,i,r,u){var f=new FormData;f.append("access_token",n);f.append("source",r);f.append("no_story",!0);$.ajax({url:"https://graph.facebook.com/me/photos?access_token="+n,type:"POST",data:f,processData:!1,contentType:!1,cache:!1,success:function(n){console.log("success: ",n);FB.api("/"+n.id+"?fields=images",function(n){n&&!n.error&&FB.api("/me/feed","POST",{message:"",picture:n.images[0].source,link:window.location.href,name:"Look at the cute panda!",description:u,privacy:{value:"SELF"}},function(n){n&&!n.error&&(console.log("Posted story to facebook"),console.log(n))})})},error:function(n,t,i){console.log("error "+i+" Status "+n.status)},complete:function(){}})}function drawLines(){var n=canvas.getContext("2d"),f=[],i;contaOccorrenze([],f);var r=canvas.width,u=canvas.height,e=r/36.08,o=u/15.06;for(i=0;i<indiceWayPoint.Index+1;i+=2){var t=Math.floor(i/2),s=getPoint(data.liftsTaken[t].liftStartLeft,r)+e,h=getPoint(data.liftsTaken[t].liftEndLeft,r)+e,c=getPoint(data.liftsTaken[t].liftStartTop,u)+o,l=getPoint(data.liftsTaken[t].liftEndTop,u)+o;n.beginPath();n.moveTo(h,l);n.lineTo(s,c);n.lineWidth=4;n.strokeStyle=getHeatMap(f[t]);n.stroke();n.beginPath();n.arc(h,l,5,0,2*Math.PI,!1);n.fillStyle="#506d7a";n.fill();n.beginPath();n.arc(s,c,5,0,2*Math.PI,!1);n.fillStyle="#506d7a";n.fill()}}function contaOccorrenze(n,t){for(var r=data.liftsTaken,i=0,u=r.length;i<u;i++)n.push(r[i]),t.push(findOccurrences(r.slice(0,i),r[i]))}function findOccurrences(n,t){for(var u=1,i=0,r=n.length;i<r;i++)LiftsTakenEquals(n[i],t)&&u++;return u}function getHeatMap(n){return n>heatMap.length?heatMap[heatMap.length]:heatMap[n]}function squash(n){for(var i=[],t=0;t<n.length;t++)i.indexOf(n[t])==-1&&i.push(n[t]);return i}function prepareAvatar(){var n,r;avatar.hide();n=avatar.find("img");n.attr("src",data.avatar);window.innerWidth>768?n.attr("style","height:40px; width:40px;"):n.attr("style","height:20px; width:20px;");var t=canvas.width,i=canvas.height,u=t/126.6,f=i/17.8;$.each(data.liftsTaken,function(n,r){arrayDistanzaX.push(getPoint(r.liftEndLeft,t)+u);arrayDistanzaY.push(getPoint(r.liftEndTop,i)+f);arrayDistanzaX.push(getPoint(r.liftStartLeft,t)+u);arrayDistanzaY.push(getPoint(r.liftStartTop,i)+f)});avatar.css("top",arrayDistanzaY[0]+"px");avatar.css("left",arrayDistanzaX[0]+"px");r=$("#avatarName");r.text(data.userName+" "+data.userSurname);r.css("margin-left",-(avatar.width()/2)+20+"px");avatar.show();avatarReady=!0}function doMove(){if(indiceWayPoint.Index%2==0&&avatar.addClass("notransition"),updateAvatar(),indiceWayPoint.Index===arrayDistanzaX.length-1){buttonStopPress(!0);return}indiceWayPoint.increaseIndex()}function updateAvatar(){avatar.css("top",arrayDistanzaY[indiceWayPoint.Index]+"px");avatar.css("left",arrayDistanzaX[indiceWayPoint.Index]+"px");avatar[0].offsetHeight;avatar.removeClass("notransition");indiceWayPoint.Index%2==1&&(drawImage(),drawLines());indiceWayPoint.Index==0&&drawImage()}function doMoveAtPoint(n){clearInterval(timer);indiceWayPoint.Index=n;updateAvatar();(state=="play"||state=="resume")&&(timer=setInterval(doMove,1100))}function doMoveAtLift(n){clearInterval(timer);var t=data.liftsTaken.indexOf(n);t!=-1&&(indiceWayPoint.Index=t,updateAvatar(),(state=="play"||state=="resume")&&(timer=setInterval(doMove,1100)))}function buttonBackPress(){console.log("button back invoked.")}function buttonForwardPress(){console.log("button forward invoked.")}function buttonRewindPress(){console.log("button rewind invoked.")}function buttonFastforwardPress(){console.log("button fast forward invoked.")}function buttonPlayPress(){if(state=="stop"){state="play";var n=$("#button_play i");n.attr("class","fa fa-pause");doMove;timer=setInterval(doMove,1100)}else state=="play"||state=="resume"?(state="pause",$("#button_play i").attr("class","fa fa-play"),clearInterval(timer)):state=="pause"&&(state="resume",$("#button_play i").attr("class","fa fa-pause"),doMove,timer=setInterval(doMove,1100));console.log("button play pressed, play was "+state)}function buttonStopPress(n){state="stop";clearInterval(timer);var t=$("#button_play i");t.attr("class","fa fa-play");n||doMoveAtPoint(0);console.log("button stop invoked.")}function loadGraph(){function h(n,t){var i=n/53;return moment(t).add(i,"minutes")}var e=[],n=[],o=[],s=[],t=[],u=[],i=[],r=[],f=moment(data.liftsTaken[0].liftTime).startOf("day");$.each(data.liftsTaken,function(c,l){e.push(l.arrAlt);o.push(l.difAlt);s.push(l.liftTime);n.push(l.startAlt);n.push(l.arrAlt);n.push(NaN);t.push(moment(l.liftTime).format("H:mm"));t.push("");t.push("");r.push(l);r.push(l);r.push(l);i.push(l.liftName);i.push(l.liftName);i.push(l.liftName);u.push(Math.abs(f.diff(l.liftTime,"seconds")));u.push(Math.abs(f.diff(h(l.difAlt,l.liftTime),"seconds")))});var v={responsive:!1,spanGaps:!0,hover:{animationDuration:0},elements:{line:{borderWidth:2,tension:.4,borderColor:"rgba(232, 78, 27, 0.43)",backgroundColor:"#e84e1b",fill:!1},point:{pointBorderColor:"#506d7a",pointBackgroundColor:"#e84e1b",radius:5}},scales:{yAxes:[{id:"y-axis-1",type:"linear",display:!0,position:"right",gridLines:{display:!1},ticks:{beginAtZero:!1,userCallback:function(n){return n+"mt"}}}],xAxes:[{id:"x-axis-1",display:!0,position:"bottom"}]}},c={responsive:!1,legend:{display:!1},hover:{animationDuration:0},animation:{duration:1,onComplete:function(){var t=this.chart,n=t.ctx;n.font=Chart.helpers.fontString(Chart.defaults.global.defaultFontSize,Chart.defaults.global.defaultFontStyle,Chart.defaults.global.defaultFontColor);n.textAlign="center";n.textBaseline="bottom"}},elements:{line:{borderWidth:4,tension:0,borderColor:"#e84e1b",backgroundColor:"#e84e1b",fill:!1},point:{pointBorderColor:"#506d7a",radius:15}},tooltips:{enabled:!1,custom:function(t){function a(n){return n.lines}var u=document.getElementById("chartjs-tooltip"),f,s,l,o;if(t.opacity===0){u.style.opacity="0";return}if(u.classList.remove("above","below","no-transform"),t.yAlign?u.classList.add(t.yAlign):u.classList.add("no-transform"),f=t.dataPoints[0].index,s=r[f],t.body){var v=i[f],y=n[f],h=s.icon,c="";h&&(c="img/"+h.replace("svg","png"));var w=t.title||[],p=t.body.map(a),e='<tr><td rowspan="2"><img src="'+c+'" title="" alt="" border="0"><\/td>';e+="<th>"+v+"<\/th><\/tr>";p.forEach(function(n,i){var u=t.labelColors[i],r="background:"+u.backgroundColor,f;r+="; border-color:"+u.borderColor;r+="; border-width: 2px";f='<span class="chartjs-tooltip-key" style="'+r+'"><\/span>';e+="<tr><td>"+f+y+" mt<\/td><\/tr>"});l=u.querySelector("table");l.innerHTML=e}o=this._chart.canvas;u.style.opacity="1";u.style.left=o.offsetLeft+t.caretX+"px";u.style.top=o.offsetTop+t.caretY+"px";u.style.fontFamily=t._fontFamily;u.style.fontSize=t.fontSize;u.style.fontStyle=t._fontStyle;u.style.padding=t.yPadding+"px "+t.xPadding+"px";doMoveAtPoint(Math.round(f*2/3))}},scales:{yAxes:[{id:"y-axis-1",type:"linear",display:!0,position:"left",gridLines:{display:!0},ticks:{beginAtZero:!1,userCallback:function(n){return n+"mt"}}},{id:"y-axis-1",type:"linear",display:!0,position:"right",gridLines:{display:!0},ticks:{beginAtZero:!1,userCallback:function(n){return n+"mt"}}}],xAxes:[{id:"x-axis-1",display:!0,position:"bottom"}]}},l=document.getElementById("myChart").getContext("2d"),a={labels:t,datasets:[{data:n,borderWidth:0,type:"line",spanGaps:!1,beginAtZero:!1,pointRadius:5,pointHoverRadius:5,pointHitRadius:5,pointBackgroundColor:"#506d7a"},{data:n,borderWidth:10,type:"line",borderDash:[6,3],borderColor:"#e84e1b",pointBorderWidth:1,radius:0,beginAtZero:!1},{data:n,borderWidth:0,borderColor:"rgba(80, 109, 122, 0.41)",type:"line",spanGaps:!0,radius:0,beginAtZero:!1}]};myLineChart=new Chart(l,{type:"line",data:a,options:c})}var token,hdnUserId,setHeaderForLogin=function(n){n.setRequestHeader("Authorization",'Basic "'+Base64.encode(hackUsername+":"+hackPassword)+'"')},setCustomHeaderToken=function(n){n.setRequestHeader("Authorization","JWT "+token)},ControllerRequest=function(){this.GetMessageLogin=function(n){token=n.token;hdnUserId=n.UserID;SetData()};this.GetMessage=function(n){setData(n)}},domain="http://testapib2c.alpaloo.com/",hackUsername="mia@tua.it",hackPassword="nessuna",myChart,data,indiceWayPoint,timer,avatarReady=!1,avatar,arrayDistanzaX=[],arrayDistanzaY=[],state="stop",mioBody,canvas,imgSize,imgResort,qs,WayPointIndex,heatMap,Chart,myLineChart;$(document).ready(function(){mioBody=$("body");indiceWayPoint=new WayPointIndex;SetToken();avatar=$("#avatar");jQuery(document).on("click","#divFB",function(){ShareFB()})});qs=function(n){var r,t,i;if(n=="")return{};for(r={},t=0;t<n.length;++t)i=n[t].split("=",2),r[i[0]]=i.length==1?"":decodeURIComponent(i[1].replace(/\+/g," "));return r}(window.location.search.substr(1).split("&"));WayPointIndex=function(){function n(){this._index=0}return Object.defineProperty(n.prototype,"Index",{get:function(){return this._index},set:function(n){this._index=n},enumerable:!0,configurable:!0}),n.prototype.increaseIndex=function(){this.Index=this._index+1},n}();heatMap=["#f8c9b9","#f4a58b","#f19374","#ef815d","#ea5d2e","#e84e1b"];Array.prototype.indexOf||(Array.prototype.indexOf=function(n,t){var i,f,r,u;if(this==null)throw new TypeError('"this" is null or not defined');if((f=Object(this),r=f.length>>>0,r===0)||(u=t|0,u>=r))return-1;for(i=Math.max(u>=0?u:r-Math.abs(u),0);i<r;){if(i in f&&f[i]===n)return i;i++}return-1});