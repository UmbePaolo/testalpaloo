function SetToken(){SendAjaxRequest("api/auth/login",null,setHeaderForLogin,"GetMessageLogin")}function SendAjaxRequest(n,t,i,r){$.ajax({url:domain+n,type:"POST",dataType:"json",data:t,processData:!1,success:function(n){var t=new ControllerRequest;t[r](n)},error:function(){},beforeSend:i})}function SetData(){var n=qs.date.split("/"),t=n[2]+"-"+n[1]+"-"+n[0],i={UserId:qs.uid,userRequestId:qs.uid,Date:t},r=JSON.stringify(i);SendAjaxRequest("api/skiday",r,setCustomHeaderToken,"GetMessage")}function setData(n){if(n&&(data=n,!(data.liftsTaken.length<1))){data.liftsTaken.sort(function(n,t){return n.liftTime<t.liftTime?-1:n.liftTime>t.liftTime?1:0});$("meta[property=og\\:title]").attr("content","La mia giornata sci a "+data.resortName);var t="Metri risaliti: "+data.mtTotRisaliti+" – Ore di attività: "+data.hTotAttivita+" – Impianti presi: "+data.liftsTaken.length;$("meta[property=og\\:description]").attr("content",t);loadImage()}}function LiftsTakenEquals(n,t){return!n||!t?!1:n.liftName===t.liftName}function loadImage(){var n=document.createElement("img");if(n)switch(data.resortName){case"Courmayeur":n.src="img/Courmayeur.png";break;case"Monterosa":n.src="img/Monterosa.png";case"La Thuile":n.src="img/LaThuile.png";break;default:n.src="img/Courmayeur.png"}n.onload=function(){var t,r,i;canvas=document.getElementById("imgCanvas");t=canvas.getContext("2d");r=$(window).innerWidth()/n.width;canvas.height=n.height*r;canvas.width=$(window).innerWidth();i=calculateAspectRatioFit(n.width,n.height,canvas.width,canvas.height);t.drawImage(n,0,0,i.width,i.height);drawLines(t);prepareAvatar();loadGrafico()}}function getPoint(n,t){return Math.floor(n/100*t)}function calculateAspectRatioFit(n,t,i,r){var u=Math.min(i/n,r/t),f=n*u,e=t*u;return{width:f,height:e}}function dataURItoBlob(n){for(var i=atob(n.split(",")[1]),r=new ArrayBuffer(i.length),u=new Uint8Array(r),t=0;t<i.length;t++)u[t]=i.charCodeAt(t);return new Blob([r],{type:"image/png"})}function ShareFB2(){var t=new GIFEncoder,n,u,i,r,f;t.setRepeat(0);t.setDelay(1e3);t.start();n=canvas.getContext("2d");indiceWayPoint.Index=0;updateAvatar();n.beginPath();n.arc(arrayDistanzaX[indiceWayPoint.Index]+20,arrayDistanzaY[indiceWayPoint.Index],20,0,2*Math.PI,!1);n.fillStyle="green";n.fill();n.lineWidth=5;n.strokeStyle="#003300";n.stroke();t.addFrame(n);indiceWayPoint.Index=1;updateAvatar();n.beginPath();n.arc(arrayDistanzaX[indiceWayPoint.Index]+20,arrayDistanzaY[indiceWayPoint.Index],20,0,2*Math.PI,!1);n.fillStyle="green";n.fill();n.lineWidth=5;n.strokeStyle="#003300";n.stroke();t.addFrame(n);indiceWayPoint.Index=2;updateAvatar();n.beginPath();n.arc(arrayDistanzaX[indiceWayPoint.Index]+20,arrayDistanzaY[indiceWayPoint.Index],20,0,2*Math.PI,!1);n.fillStyle="green";n.fill();n.lineWidth=5;n.strokeStyle="#003300";n.stroke();t.addFrame(n);indiceWayPoint.Index=3;updateAvatar();n.beginPath();n.arc(arrayDistanzaX[indiceWayPoint.Index]+20,arrayDistanzaY[indiceWayPoint.Index],20,0,2*Math.PI,!1);n.fillStyle="green";n.fill();n.lineWidth=5;n.strokeStyle="#003300";n.stroke();t.addFrame(n);t.finish();u=t.stream().getData();i=encode64(u);console.log(i);r=location.origin+"/";f=data.userName+data.userSurname;$.ajax({type:"POST",url:"UploadImageService.asmx/UploadImage",data:JSON.stringify({imageData:i,name:f}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(n){$("body").append('<meta property="og:image" content="'+r+n.d+'" />');FB.ui({method:"share",href:window.location.href,picture:r+n.d},function(){})})}function encode64(n){for(var e="",t=0,l=n.length,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o,r,u,h,c,s,f;t<l;)o=n.charCodeAt(t++),r=n.charCodeAt(t++),u=n.charCodeAt(t++),h=o>>2,c=(o&3)<<4|r>>4,s=(r&15)<<2|u>>6,f=u&63,isNaN(r)?s=f=64:isNaN(u)&&(f=64),e=e+i.charAt(h)+i.charAt(c)+i.charAt(s)+i.charAt(f);return e}function ShareFB(){var r=canvas.toDataURL("image/png"),u,n,i,t;try{u=dataURItoBlob(r)}catch(f){console.log(f)}$("#divFB").data("href",window.location.href);n=canvas.toDataURL("image/png");n=n.replace("data:image/png;base64,","");i=data.userName+data.userSurname;t=location.origin+"/";$.ajax({type:"POST",url:"UploadImageService.asmx/UploadImage",data:JSON.stringify({imageData:n,name:i}),contentType:"application/json; charset=utf-8",dataType:"json"}).done(function(n){$("body").append('<meta property="og:image" content="'+t+n.d+'" />');FB.ui({method:"share",href:window.location.href,picture:t+n.d},function(){})})}function postImageToFacebook(n,t,i,r,u){var f=new FormData;f.append("access_token",n);f.append("source",r);f.append("no_story",!0);$.ajax({url:"https://graph.facebook.com/me/photos?access_token="+n,type:"POST",data:f,processData:!1,contentType:!1,cache:!1,success:function(n){console.log("success: ",n);FB.api("/"+n.id+"?fields=images",function(n){n&&!n.error&&FB.api("/me/feed","POST",{message:"",picture:n.images[0].source,link:window.location.href,name:"Look at the cute panda!",description:u,privacy:{value:"SELF"}},function(n){n&&!n.error&&(console.log("Posted story to facebook"),console.log(n))})})},error:function(n,t,i){console.log("error "+i+" Status "+n.status)},complete:function(){}})}function drawLines(n){var i=[],f=[],r,u,t;for(contaOccorrenze(i,f),r=canvas.width,u=canvas.height,t=0;t<i.length;t++){var e=getPoint(i[t].liftStartLeft,r)+35,o=getPoint(i[t].liftEndLeft,r)+35,s=getPoint(i[t].liftStartTop,u)+65,h=getPoint(i[t].liftEndTop,u)+65;n.beginPath();n.moveTo(o,h);n.lineTo(e,s);n.lineWidth=4;n.strokeStyle=getHeatMap(f[t]);n.stroke();n.beginPath();n.arc(o,h,5,0,2*Math.PI,!1);n.fillStyle="#506d7a";n.fill();n.beginPath();n.arc(e,s,5,0,2*Math.PI,!1);n.fillStyle="#506d7a";n.fill()}}function contaOccorrenze(n,t){var f,r=data.liftsTaken.slice(),u,e,i;for(r.sort(function(n,t){return n.liftName<t.liftName?-1:n.liftName>t.liftName?1:0}),i=0;i<r.length;i++)LiftsTakenEquals(r[i],f)?t[t.length-1]++:(n.push(r[i]),t.push(0)),f=r[i];if(u=squash(t),u.length=2)for(e=Math.max(u[0],u[1]),i=0;i<t.length;i++)t[i]==e&&(t[i]=heatMap.length-1)}function getHeatMap(n){return n>heatMap.length?heatMap[heatMap.length]:heatMap[n]}function squash(n){for(var i=[],t=0;t<n.length;t++)i.indexOf(n[t])==-1&&i.push(n[t]);return i}function prepareAvatar(){var n,t,i;avatar.hide();avatar.find("img").attr("src",data.avatar);n=canvas.width;t=canvas.height;$.each(data.liftsTaken,function(i,r){arrayDistanzaX.push(getPoint(r.liftEndLeft,n)+10);arrayDistanzaY.push(getPoint(r.liftEndTop,t)+55);arrayDistanzaX.push(getPoint(r.liftStartLeft,n)+10);arrayDistanzaY.push(getPoint(r.liftStartTop,t)+55)});avatar.css("top",arrayDistanzaY[0]+"px");avatar.css("left",arrayDistanzaX[0]+"px");indiceWayPoint.increaseIndex();i=$("#avatarName");i.text(data.userName+" "+data.userSurname);i.css("margin-left",-(avatar.width()/2)+20+"px");avatar.show();avatarReady=!0}function doMove(){if(indiceWayPoint.Index%2==0&&avatar.addClass("notransition"),updateAvatar(),myChart.series[0].points[indiceWayPoint.Index].select(),indiceWayPoint.Index===arrayDistanzaX.length-1){buttonStopPress();return}indiceWayPoint.increaseIndex()}function updateAvatar(){avatar.css("top",arrayDistanzaY[indiceWayPoint.Index]+"px");avatar.css("left",arrayDistanzaX[indiceWayPoint.Index]+"px");avatar[0].offsetHeight;avatar.removeClass("notransition")}function doMoveAtPoint(n){clearInterval(timer);indiceWayPoint.Index=n;updateAvatar();(state=="play"||state=="resume")&&(timer=setInterval(doMove,1100))}function buttonBackPress(){console.log("button back invoked.")}function buttonForwardPress(){console.log("button forward invoked.")}function buttonRewindPress(){console.log("button rewind invoked.")}function buttonFastforwardPress(){console.log("button fast forward invoked.")}function buttonPlayPress(){if(state=="stop"){state="play";var n=$("#button_play i");n.attr("class","fa fa-pause");doMove;timer=setInterval(doMove,1100)}else state=="play"||state=="resume"?(state="pause",$("#button_play i").attr("class","fa fa-play"),clearInterval(timer)):state=="pause"&&(state="resume",$("#button_play i").attr("class","fa fa-pause"),doMove,timer=setInterval(doMove,1100));console.log("button play pressed, play was "+state)}function buttonStopPress(){state="stop";clearInterval(timer);var n=$("#button_play i");n.attr("class","fa fa-play");doMoveAtPoint(0);myChart.series[0].points[0].select();console.log("button stop invoked.")}function loadGrafico(){var n=[],i=Highcharts.setOptions({lang:{loading:"Sto caricando...",months:["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],weekdays:["Domenica","Lunedì","Martedì","Mercoledì","Giovedì","Venerdì","Sabato"],shortMonths:["Gen","Feb","Mar","Apr","Mag","Giu","Lugl","Ago","Set","Ott","Nov","Dic"],exportButtonTitle:"Esporta",printButtonTitle:"Importa",rangeSelectorFrom:"Da",rangeSelectorTo:"A",rangeSelectorZoom:"Periodo",downloadPNG:"Download immagine PNG",downloadJPEG:"Download immagine JPEG",downloadPDF:"Download documento PDF",downloadSVG:"Download immagine SVG",printChart:"Stampa grafico",thousandsSep:".",decimalPoint:","}}),t;$.each(data.liftsTaken,function(t,i){var r=new Date(i.liftTime),f=Date.UTC(r.getFullYear(),r.getMonth(),r.getDay(),r.getHours(),r.getMinutes(),r.getSeconds()),u={x:f,y:i.arrAlt-i.difAlt,custImg:"img/"+i.icon.replace("svg","png"),custResort:i.liftName};n.push(u);u={x:f+3e5,y:i.arrAlt,custImg:"img/"+i.icon.replace("svg","png"),custResort:i.liftName};n.push(u)});t={colors:["#2b908f","#90ee7e","#f45b5b","#7798BF","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353","#7798BF","#aaeeee"],title:{text:""},legend:{enabled:!1},tooltip:{useHTML:!0,formatter:function(){var t=this.point.custImg,i=this.point.custResort,n="";return t&&(n='<img src="'+t+'" title="" alt="" border="0">'+n),i&&(n=n+"<b>"+i+"<\/b><br/>"),'<div style="width:100px; height:50px;">'+n+this.point.y+" mt<\/div>"},backgroundColor:"#e84e1b"},xAxis:{gridLineColor:"#707073",labels:{style:{color:"#E0E0E3"}},lineColor:"#707073",minorGridLineColor:"#505053",tickColor:"#707073",title:{style:{color:"#A0A0A3"}},type:"datetime",dateTimeLabelFormats:{minute:"%H:%M:%S"}},yAxis:{gridLineColor:"#707073",labels:{style:{color:"#E0E0E3"}},lineColor:"#707073",minorGridLineColor:"#505053",tickColor:"#707073",tickWidth:1,title:{text:"",style:{color:"#A0A0A3"}},stackLabels:{enabled:!0,style:{fontWeight:"bold",color:Highcharts.theme&&Highcharts.theme.textColor||"gray"}}},plotOptions:{series:{allowPointSelect:!0,marker:{enabled:!0,states:{select:{enabled:!0,fillColor:"red",radius:6}}},point:{events:{click:function(){doMoveAtPoint(this.index)}}}}},chart:{color:"",renderTo:$("#myChart")[0],type:"line",plotBorderColor:"#606063"},series:[{}]};t.series[0].data=n;myChart=new Highcharts.Chart(t);myChart.series[0].points[0].select();$(".highcharts-button").hide()}var token,hdnUserId,setHeaderForLogin=function(n){n.setRequestHeader("Authorization",'Basic "'+Base64.encode(hackUsername+":"+hackPassword)+'"')},setCustomHeaderToken=function(n){n.setRequestHeader("Authorization","JWT "+token)},ControllerRequest=function(){this.GetMessageLogin=function(n){token=n.token;hdnUserId=n.UserID;SetData()};this.GetMessage=function(n){setData(n)}},domain="http://testapib2c.alpaloo.com/",hackUsername="mia@tua.it",hackPassword="nessuna",myChart,data,indiceWayPoint,timer,avatarReady=!1,avatar,arrayDistanzaX=[],arrayDistanzaY=[],state="stop",mioBody,canvas,qs,WayPointIndex,heatMap;$(document).ready(function(){mioBody=$("body");indiceWayPoint=new WayPointIndex;SetToken();avatar=$("#avatar");jQuery(document).on("click","#divFB",function(){ShareFB2()})});qs=function(n){var r,t,i;if(n=="")return{};for(r={},t=0;t<n.length;++t)i=n[t].split("=",2),r[i[0]]=i.length==1?"":decodeURIComponent(i[1].replace(/\+/g," "));return r}(window.location.search.substr(1).split("&"));WayPointIndex=function(){function n(){this._index=0}return Object.defineProperty(n.prototype,"Index",{get:function(){return this._index},set:function(n){this._index=n},enumerable:!0,configurable:!0}),n.prototype.increaseIndex=function(){this._index++},n}();heatMap=["#f8c9b9","#f4a58b","#f19374","#ef815d","#ea5d2e","#e84e1b"];Array.prototype.indexOf||(Array.prototype.indexOf=function(n,t){var i,f,r,u;if(this==null)throw new TypeError('"this" is null or not defined');if((f=Object(this),r=f.length>>>0,r===0)||(u=t|0,u>=r))return-1;for(i=Math.max(u>=0?u:r-Math.abs(u),0);i<r;){if(i in f&&f[i]===n)return i;i++}return-1});